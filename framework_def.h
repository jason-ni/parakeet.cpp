//
// Created by jason on 2025/7/26.
//
#pragma once

enum ggmlf_tensor {
    GGMLF_TENSOR_TOKEN_EMBD,
    GGMLF_TENSOR_TOKEN_EMBD_NORM,
    GGMLF_TENSOR_TOKEN_TYPES,
    GGMLF_TENSOR_POS_EMBD,
    GGMLF_TENSOR_OUTPUT,
    GGMLF_TENSOR_OUTPUT_NORM,
    GGMLF_TENSOR_ROPE_FREQS,
    GGMLF_TENSOR_ROPE_FACTORS_LONG,
    GGMLF_TENSOR_ROPE_FACTORS_SHORT,
    GGMLF_TENSOR_ATTN_Q,
    GGMLF_TENSOR_ATTN_K,
    GGMLF_TENSOR_ATTN_V,
    GGMLF_TENSOR_ATTN_QKV,
    GGMLF_TENSOR_ATTN_OUT,
    GGMLF_TENSOR_ATTN_NORM,
    GGMLF_TENSOR_ATTN_NORM_2,
    GGMLF_TENSOR_ATTN_OUT_NORM,
    GGMLF_TENSOR_ATTN_POST_NORM,
    GGMLF_TENSOR_ATTN_ROT_EMBD,
    GGMLF_TENSOR_FFN_GATE_INP,
    GGMLF_TENSOR_FFN_GATE_INP_SHEXP,
    GGMLF_TENSOR_FFN_NORM,
    GGMLF_TENSOR_FFN_POST_NORM,
    GGMLF_TENSOR_FFN_GATE,
    GGMLF_TENSOR_FFN_DOWN,
    GGMLF_TENSOR_FFN_UP,
    GGMLF_TENSOR_FFN_ACT,
    GGMLF_TENSOR_FFN_DOWN_EXP,  // split experts for backward compatibility
    GGMLF_TENSOR_FFN_GATE_EXP,
    GGMLF_TENSOR_FFN_UP_EXP,
    GGMLF_TENSOR_FFN_NORM_EXPS,
    GGMLF_TENSOR_FFN_DOWN_EXPS, // merged experts
    GGMLF_TENSOR_FFN_GATE_EXPS,
    GGMLF_TENSOR_FFN_UP_EXPS,
    GGMLF_TENSOR_FFN_DOWN_SHEXP,
    GGMLF_TENSOR_FFN_GATE_SHEXP,
    GGMLF_TENSOR_FFN_UP_SHEXP,
    GGMLF_TENSOR_ATTN_Q_NORM,
    GGMLF_TENSOR_ATTN_K_NORM,
    GGMLF_TENSOR_LAYER_OUT_NORM,
    GGMLF_TENSOR_SSM_IN,
    GGMLF_TENSOR_SSM_CONV1D,
    GGMLF_TENSOR_SSM_X,
    GGMLF_TENSOR_SSM_DT,
    GGMLF_TENSOR_SSM_A,
    GGMLF_TENSOR_SSM_D,
    GGMLF_TENSOR_SSM_OUT,
    GGMLF_TENSOR_TIME_MIX_W1,
    GGMLF_TENSOR_TIME_MIX_W2,
    GGMLF_TENSOR_TIME_MIX_LERP_X,
    GGMLF_TENSOR_TIME_MIX_LERP_W,
    GGMLF_TENSOR_TIME_MIX_LERP_K,
    GGMLF_TENSOR_TIME_MIX_LERP_V,
    GGMLF_TENSOR_TIME_MIX_LERP_R,
    GGMLF_TENSOR_TIME_MIX_LERP_G,
    GGMLF_TENSOR_TIME_MIX_FIRST,
    GGMLF_TENSOR_TIME_MIX_DECAY,
    GGMLF_TENSOR_TIME_MIX_DECAY_W1,
    GGMLF_TENSOR_TIME_MIX_DECAY_W2,
    GGMLF_TENSOR_TIME_MIX_KEY,
    GGMLF_TENSOR_TIME_MIX_VALUE,
    GGMLF_TENSOR_TIME_MIX_RECEPTANCE,
    GGMLF_TENSOR_TIME_MIX_GATE,
    GGMLF_TENSOR_TIME_MIX_LN,
    GGMLF_TENSOR_TIME_MIX_OUTPUT,
    GGMLF_TENSOR_CHANNEL_MIX_LERP_K,
    GGMLF_TENSOR_CHANNEL_MIX_LERP_R,
    GGMLF_TENSOR_CHANNEL_MIX_KEY,
    GGMLF_TENSOR_CHANNEL_MIX_RECEPTANCE,
    GGMLF_TENSOR_CHANNEL_MIX_VALUE,
    GGMLF_TENSOR_ATTN_Q_A,
    GGMLF_TENSOR_ATTN_Q_B,
    GGMLF_TENSOR_ATTN_KV_A_MQA,
    GGMLF_TENSOR_ATTN_KV_B,
    GGMLF_TENSOR_ATTN_Q_A_NORM,
    GGMLF_TENSOR_ATTN_KV_A_NORM,
    GGMLF_TENSOR_ATTN_SUB_NORM,
    GGMLF_TENSOR_FFN_SUB_NORM,
    GGMLF_TENSOR_DEC_ATTN_NORM,
    GGMLF_TENSOR_DEC_ATTN_Q,
    GGMLF_TENSOR_DEC_ATTN_K,
    GGMLF_TENSOR_DEC_ATTN_V,
    GGMLF_TENSOR_DEC_ATTN_OUT,
    GGMLF_TENSOR_DEC_ATTN_REL_B,
    GGMLF_TENSOR_DEC_CROSS_ATTN_NORM,
    GGMLF_TENSOR_DEC_CROSS_ATTN_Q,
    GGMLF_TENSOR_DEC_CROSS_ATTN_K,
    GGMLF_TENSOR_DEC_CROSS_ATTN_V,
    GGMLF_TENSOR_DEC_CROSS_ATTN_OUT,
    GGMLF_TENSOR_DEC_CROSS_ATTN_REL_B,
    GGMLF_TENSOR_DEC_FFN_NORM,
    GGMLF_TENSOR_DEC_FFN_GATE,
    GGMLF_TENSOR_DEC_FFN_DOWN,
    GGMLF_TENSOR_DEC_FFN_UP,
    GGMLF_TENSOR_DEC_OUTPUT_NORM,
    GGMLF_TENSOR_ENC_ATTN_NORM,
    GGMLF_TENSOR_ENC_ATTN_Q,
    GGMLF_TENSOR_ENC_ATTN_K,
    GGMLF_TENSOR_ENC_ATTN_V,
    GGMLF_TENSOR_ENC_ATTN_OUT,
    GGMLF_TENSOR_ENC_ATTN_REL_B,
    GGMLF_TENSOR_ENC_FFN_NORM,
    GGMLF_TENSOR_ENC_FFN_GATE,
    GGMLF_TENSOR_ENC_FFN_DOWN,
    GGMLF_TENSOR_ENC_FFN_UP,
    GGMLF_TENSOR_ENC_OUTPUT_NORM,
    GGMLF_TENSOR_CLS,
    GGMLF_TENSOR_CLS_OUT,
    GGMLF_TENSOR_CONV1D,
    GGMLF_TENSOR_CONVNEXT_DW,
    GGMLF_TENSOR_CONVNEXT_NORM,
    GGMLF_TENSOR_CONVNEXT_PW1,
    GGMLF_TENSOR_CONVNEXT_PW2,
    GGMLF_TENSOR_CONVNEXT_GAMMA,
    GGMLF_TENSOR_POS_NET_CONV1,
    GGMLF_TENSOR_POS_NET_CONV2,
    GGMLF_TENSOR_POS_NET_NORM,
    GGMLF_TENSOR_POS_NET_NORM1,
    GGMLF_TENSOR_POS_NET_NORM2,
    GGMLF_TENSOR_POS_NET_ATTN_NORM,
    GGMLF_TENSOR_POS_NET_ATTN_Q,
    GGMLF_TENSOR_POS_NET_ATTN_K,
    GGMLF_TENSOR_POS_NET_ATTN_V,
    GGMLF_TENSOR_POS_NET_ATTN_OUT,
    GGMLF_TENSOR_LLM_DECODER,
    GGMLF_TENSOR_BIAS,
};

static const std::map<ggmlf_tensor, ggml_op> ggmlf_tensor_info_mapping = {
    {GGMLF_TENSOR_TOKEN_EMBD,  GGML_OP_GET_ROWS},
    {GGMLF_TENSOR_POS_EMBD,  GGML_OP_GET_ROWS},
    {GGMLF_TENSOR_TOKEN_EMBD_NORM,  GGML_OP_GET_ROWS},
    {GGMLF_TENSOR_TOKEN_TYPES,  GGML_OP_GET_ROWS},
    {GGMLF_TENSOR_OUTPUT,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_CLS,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_CLS_OUT,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_OUTPUT_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_DEC_OUTPUT_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_ENC_OUTPUT_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_ROPE_FREQS,  GGML_OP_ROPE},
    {GGMLF_TENSOR_ROPE_FACTORS_LONG,  GGML_OP_ROPE},
    {GGMLF_TENSOR_ROPE_FACTORS_SHORT,  GGML_OP_ROPE},
    {GGMLF_TENSOR_ATTN_Q,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_K,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_V,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_QKV,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_OUT,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_FFN_GATE,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_FFN_DOWN,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_FFN_UP,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_FFN_DOWN_SHEXP,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_FFN_GATE_SHEXP,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_FFN_UP_SHEXP,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_Q_A,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_Q_B,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_KV_A_MQA,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_KV_B,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_DEC_ATTN_Q,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_DEC_ATTN_K,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_Q,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_K,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_V,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_QKV,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_OUT,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_FFN_GATE,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_FFN_DOWN,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_FFN_UP,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_FFN_DOWN_SHEXP,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_FFN_GATE_SHEXP,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_FFN_UP_SHEXP,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_Q_A,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_Q_B,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_KV_A_MQA,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ATTN_KV_B,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_DEC_ATTN_Q,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_DEC_ATTN_K,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_DEC_ATTN_V,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_DEC_ATTN_OUT,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_DEC_CROSS_ATTN_Q,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_DEC_CROSS_ATTN_K,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_DEC_CROSS_ATTN_V,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_DEC_CROSS_ATTN_OUT,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_DEC_FFN_GATE,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_DEC_FFN_DOWN,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_DEC_FFN_UP,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ENC_ATTN_Q,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ENC_ATTN_K,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ENC_ATTN_V,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ENC_ATTN_OUT,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ENC_FFN_GATE,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ENC_FFN_DOWN,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_ENC_FFN_UP,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_FFN_GATE_INP_SHEXP,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_FFN_GATE_INP,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_SSM_IN,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_SSM_X,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_SSM_DT,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_SSM_OUT,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_TIME_MIX_W1,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_TIME_MIX_W2,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_TIME_MIX_DECAY_W1,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_TIME_MIX_DECAY_W2,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_TIME_MIX_KEY,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_TIME_MIX_VALUE,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_TIME_MIX_RECEPTANCE,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_TIME_MIX_GATE,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_TIME_MIX_OUTPUT,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_CHANNEL_MIX_KEY,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_CHANNEL_MIX_RECEPTANCE,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_CHANNEL_MIX_VALUE,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_FFN_ACT,  GGML_OP_DIV},
    {GGMLF_TENSOR_SSM_CONV1D,  GGML_OP_SSM_CONV},
    {GGMLF_TENSOR_SSM_A,  GGML_OP_SSM_SCAN},
    {GGMLF_TENSOR_SSM_D,  GGML_OP_MUL},
    {GGMLF_TENSOR_TIME_MIX_LERP_X,  GGML_OP_MUL},
    {GGMLF_TENSOR_TIME_MIX_LN,  GGML_OP_MUL},
    {GGMLF_TENSOR_CHANNEL_MIX_LERP_K,  GGML_OP_MUL},
    {GGMLF_TENSOR_CHANNEL_MIX_LERP_R,  GGML_OP_MUL},
    {GGMLF_TENSOR_BIAS,  GGML_OP_ADD},
    {GGMLF_TENSOR_TIME_MIX_LERP_W,  GGML_OP_ADD},
    {GGMLF_TENSOR_TIME_MIX_LERP_K,  GGML_OP_ADD},
    {GGMLF_TENSOR_TIME_MIX_LERP_V,  GGML_OP_ADD},
    {GGMLF_TENSOR_TIME_MIX_LERP_R,  GGML_OP_ADD},
    {GGMLF_TENSOR_TIME_MIX_LERP_G,  GGML_OP_ADD},
    {GGMLF_TENSOR_TIME_MIX_DECAY,  GGML_OP_ADD},
    {GGMLF_TENSOR_TIME_MIX_FIRST,  GGML_OP_RWKV_WKV6},
    {GGMLF_TENSOR_ATTN_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_ATTN_NORM_2,  GGML_OP_MUL},
    {GGMLF_TENSOR_ATTN_OUT_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_ATTN_POST_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_FFN_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_FFN_POST_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_FFN_NORM_EXPS,  GGML_OP_MUL},
    {GGMLF_TENSOR_ATTN_Q_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_ATTN_K_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_LAYER_OUT_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_ATTN_Q_A_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_ATTN_KV_A_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_ATTN_SUB_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_FFN_SUB_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_DEC_ATTN_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_DEC_CROSS_ATTN_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_DEC_FFN_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_ENC_ATTN_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_ENC_FFN_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_DEC_ATTN_REL_B,  GGML_OP_GET_ROWS},
    {GGMLF_TENSOR_ENC_ATTN_REL_B,  GGML_OP_GET_ROWS},
    {GGMLF_TENSOR_FFN_DOWN_EXPS,  GGML_OP_MUL_MAT_ID},
    {GGMLF_TENSOR_FFN_GATE_EXPS,  GGML_OP_MUL_MAT_ID},
    {GGMLF_TENSOR_FFN_UP_EXPS,  GGML_OP_MUL_MAT_ID},
    // this tensor is loaded for T5, but never used
    {GGMLF_TENSOR_DEC_CROSS_ATTN_REL_B,  GGML_OP_NONE},
    {GGMLF_TENSOR_CONV1D,      GGML_OP_IM2COL},
    {GGMLF_TENSOR_POS_NET_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_POS_NET_NORM1,  GGML_OP_MUL},
    {GGMLF_TENSOR_POS_NET_NORM2,  GGML_OP_MUL},
    {GGMLF_TENSOR_POS_NET_CONV1,  GGML_OP_IM2COL},
    {GGMLF_TENSOR_POS_NET_CONV2,  GGML_OP_IM2COL},
    {GGMLF_TENSOR_POS_NET_ATTN_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_POS_NET_ATTN_Q,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_POS_NET_ATTN_K,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_POS_NET_ATTN_V,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_POS_NET_ATTN_OUT,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_CONVNEXT_DW,  GGML_OP_IM2COL},
    {GGMLF_TENSOR_CONVNEXT_NORM,  GGML_OP_MUL},
    {GGMLF_TENSOR_CONVNEXT_PW1,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_CONVNEXT_PW2,  GGML_OP_MUL_MAT},
    {GGMLF_TENSOR_CONVNEXT_GAMMA,  GGML_OP_MUL},
    {GGMLF_TENSOR_LLM_DECODER,     GGML_OP_MUL_MAT},
};
